name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOTNET_VERSION: '8.0.x'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test build output
      run: |
        if (Test-Path "./bin/Release/net8.0-windows/SolusManifestApp.exe") {
          Write-Host "✅ Build successful - SolusManifestApp.exe created"
        } else {
          Write-Host "❌ Build failed - executable not found"
          exit 1
        }

    - name: Generate version tag
      if: github.event_name == 'push'
      id: version
      run: |
        $date = Get-Date -Format "yyyy.MM.dd"
        $count = git rev-list --count HEAD
        $version = "v$date.$count"
        echo "tag=$version" >> $env:GITHUB_OUTPUT
        echo "Generated version: $version"

    - name: Publish Full Self-Contained
      if: github.event_name == 'push'
      run: dotnet publish --configuration Release --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true --output ./publish/full

    - name: Publish Framework-Dependent with Dependencies
      if: github.event_name == 'push'
      run: dotnet publish --configuration Release --runtime win-x64 --self-contained false -p:PublishSingleFile=true --output ./publish/deps

    - name: Publish Framework-Dependent Minimal
      if: github.event_name == 'push'
      run: dotnet publish --configuration Release --no-self-contained --output ./publish/minimal

    - name: Remove PDB files
      if: github.event_name == 'push'
      run: |
        Remove-Item -Path ./publish/full/*.pdb -ErrorAction SilentlyContinue
        Remove-Item -Path ./publish/deps/*.pdb -ErrorAction SilentlyContinue
        Remove-Item -Path ./publish/minimal/*.pdb -ErrorAction SilentlyContinue

    - name: Create Release Archives
      if: github.event_name == 'push'
      run: |
        cd publish/full
        7z a ../../SolusManifestApp-${{ steps.version.outputs.tag }}-full.zip *
        cd ../deps
        7z a ../../SolusManifestApp-${{ steps.version.outputs.tag }}-deps.zip *
        cd ../minimal
        7z a ../../SolusManifestApp-${{ steps.version.outputs.tag }}-minimal.zip *

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: github.event_name == 'push' && success()
      with:
        name: SolusManifestApp-${{ steps.version.outputs.tag }}
        path: |
          SolusManifestApp-*.zip
        retention-days: 30

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'push' && success()
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        prerelease: false
        generate_release_notes: true
        files: |
          SolusManifestApp-${{ steps.version.outputs.tag }}-full.zip
          SolusManifestApp-${{ steps.version.outputs.tag }}-deps.zip
          SolusManifestApp-${{ steps.version.outputs.tag }}-minimal.zip
        body: |
          ## Release ${{ steps.version.outputs.tag }}

          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Commit:** ${{ github.sha }}

          ### Downloads

          Choose the version that fits your needs:

          - **Full Self-Contained** (`-full.zip`): Everything included, no .NET runtime needed (~80MB)
          - **Framework-Dependent with Dependencies** (`-deps.zip`): Requires .NET 8.0 runtime, includes other dependencies (~10MB)
          - **Minimal** (`-minimal.zip`): Requires .NET 8.0 runtime, no bundled dependencies (~1MB)

          ### Installation
          1. Download the zip file for your preferred variant
          2. Extract to a folder
          3. Run `SolusManifestApp.exe`

          **Note:** For `-deps` and `-minimal` variants, install [.NET 8.0 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) first.
      env:
        GITHUB_TOKEN: ${{ github.token }}
